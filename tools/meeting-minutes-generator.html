<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会议纪要生成器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            margin-bottom: 40px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 1.1em;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .analyze-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e5e7eb;
            position: relative;
        }

        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #374151;
            margin-right: 15px;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-content {
            background: #f8fafc;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            min-height: 150px;
            font-size: 1.05em;
            line-height: 1.6;
            color: #374151;
            white-space: pre-wrap;
            font-family: inherit;
        }

        .result-content h1, .result-content h2, .result-content h3 {
            color: #1f2937;
            margin-top: 20px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .result-content h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .result-content h2 {
            font-size: 1.3em;
            color: #4f46e5;
        }

        .result-content h3 {
            font-size: 1.2em;
            color: #6366f1;
        }

        .result-content strong {
            font-weight: 600;
            color: #1f2937;
        }

        .result-content em {
            font-style: italic;
            color: #6b7280;
        }

        .result-content p {
            margin-bottom: 12px;
        }

        .result-content ul, .result-content ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .result-content li {
            margin-bottom: 6px;
        }

        .result-content code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .result-content blockquote {
            border-left: 4px solid #4f46e5;
            padding-left: 15px;
            margin: 12px 0;
            font-style: italic;
            color: #6b7280;
        }

        .meeting-header {
            background: #fff;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .meeting-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .meeting-item {
            background: #fff;
            border-left: 3px solid #4f46e5;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .todo-item {
            background: #fff;
            border-left: 3px solid #10b981;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 0 4px 4px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .meeting-badge {
            display: inline-block;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 8px;
        }

        .date-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .time-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: none;
        }

        .copy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .result-empty {
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        .typing-cursor {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>会议纪要生成器</h1>
            <p>输入会议对话内容，自动生成规范的会议纪要</p>
        </div>
        
        <div class="main-content">
            <div class="input-section">
                <div class="form-group">
                    <label for="dialogText" class="form-label">请输入飞书妙记记录：</label>
                    <textarea 
                        id="dialogText" 
                        class="form-textarea" 
                        placeholder="请粘贴飞书妙记的会议记录内容
系统将自动过滤无关内容，生成专业的会议纪要..."
                    ></textarea>
                </div>
                <button id="generateBtn" class="analyze-btn">
                    生成会议纪要
                </button>
            </div>
            
            <div class="result-section">
                <div class="result-header">
                    <h3 class="result-title">会议纪要</h3>
                    <div id="loadingSpinner" class="loading-spinner"></div>
                </div>
                <button id="copyBtn" class="copy-btn">📋 复制结果</button>
                <div id="resultContent" class="result-content">
                    <div class="result-empty">
                        请输入会议对话内容并点击生成按钮，系统将为您生成规范的会议纪要
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://api.deepseek.com/v1';
        const API_KEY = 'sk-08fd0b2b32284162bad21e12b9f07c14';

        

        const dialogTextArea = document.getElementById('dialogText');
        const generateBtn = document.getElementById('generateBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContent = document.getElementById('resultContent');
        const copyBtn = document.getElementById('copyBtn');

        let fullContent = '';

        generateBtn.addEventListener('click', generateMeetingMinutes);
        copyBtn.addEventListener('click', copyResult);

        async function generateMeetingMinutes() {
            const dialogText = dialogTextArea.value.trim();
            
            if (!dialogText) {
                showError('请输入会议对话内容');
                return;
            }

            setLoading(true);
            fullContent = '';
            copyBtn.style.display = 'none';
            resultContent.textContent = '';

            try {
                console.log('开始生成会议纪要...');
                
                // 处理大文本：截取前3000字符或前30行对话
                let processedText = dialogText;
                const lines = dialogText.split('\n').filter(line => line.trim());
                
                if (dialogText.length > 3000 || lines.length > 30) {
                    console.log('文本较长，进行截取处理');
                    
                    // 优先保留对话内容丰富的行
                    const meaningfulLines = lines.filter(line => {
                        const content = line.replace(/^说话人\s*\d+\s+\d+:\d+/, '').trim();
                        return content.length > 5; // 只保留内容较长的对话
                    }).slice(0, 25); // 最多保留25行
                    
                    processedText = meaningfulLines.join('\n');
                    
                    if (processedText.length > 3000) {
                        processedText = processedText.substring(0, 3000) + '...';
                    }
                }
                
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: `你是一个专业的会议纪要生成专家。请根据提供的会议对话内容，生成规范的会议纪要。

重要处理原则：
1. 自动识别并过滤会议开始和结束时的寒暄、闲聊、技术调试等无关内容
2. 忽略"进错会了"、"一个人都没有"、"音响测试"、"能听到吗"等会议准备阶段的对话
3. 重点提取会议的核心议题、实质性讨论和具体的工作安排
4. 过滤掉"再见"、"下次见"、"会议结束"等结束语
5. 只保留与会议主题相关的有效讨论内容

请严格按照以下markdown格式输出，以便正确渲染富文本样式：

## 会议基本信息

**主题：** [根据核心讨论内容推测会议主题]  
**主持人：** [从实质性发言中识别主持人或主要发言人]  
**参会人员：** [列出参会人员，用、分隔]  
**日期：** 2025年8月11日  
**时间：** [推测时间，上午或下午]  

## 会议内容

1. **[主要议题1]** - 只包含实质性讨论
2. **[主要议题2]** - 排除寒暄和无关对话  
3. **[主要议题3]** - 聚焦核心工作内容
4. **[更多议题...]**

## 待办事项

1. **[具体待办事项1]** - 从实质性讨论中提取
2. **[具体待办事项2]** - 从工作安排中提取
3. **[更多待办事项...]**

## 附件

[如有文档提及则列出，否则写"无"]

请智能过滤无关内容，只基于有效的会议讨论生成纪要，确保内容的专业性和准确性。使用markdown格式以便正确显示富文本样式。`
                            },
                            {
                                role: 'user',
                                content: `请根据以下会议对话内容生成会议纪要：\n\n${processedText}`
                            }
                        ],
                        stream: true,
                        max_tokens: 2000,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                fullContent = '';
                displayContent = '';
                
                resultContent.innerHTML = '<span class="typing-cursor">|</span>';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices?.[0]?.delta?.content;
                                if (content) {
                                    fullContent += content;
                                    await typeWriter(content);
                                }
                            } catch (e) {
                                // 忽略解析错误
                            }
                        }
                    }
                }
                
                if (!fullContent.trim()) {
                    throw new Error('API返回内容为空');
                }
                
                setLoading(false);
                copyBtn.style.display = 'block';
                console.log('会议纪要生成完成，内容长度:', fullContent.length);
                
            } catch (error) {
                console.error('生成失败:', error);
                setLoading(false);
                showError(`生成失败: ${error.message || '网络连接错误'}`);
            }
        }


        async function copyResult() {
            if (!fullContent.trim()) {
                showError('没有可复制的内容');
                return;
            }

            try {
                // 处理原始内容，转换为纯文本格式
                let copyText = fullContent
                    // 去除markdown格式标记
                    .replace(/\*\*(.*?)\*\*/g, '$1')  // 去除粗体标记
                    .replace(/\*(.*?)\*/g, '$1')      // 去除斜体标记
                    .replace(/`(.*?)`/g, '$1')        // 去除代码标记
                    .replace(/^#+\s*/gm, '')          // 去除标题标记
                    // 清理多余的空行
                    .replace(/\n\s*\n\s*\n/g, '\n\n')
                    .trim();
                
                await navigator.clipboard.writeText(copyText);
                
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '✅ 已复制';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
                
            } catch (err) {
                console.error('复制失败:', err);
                showError('复制失败，请手动选择内容复制');
            }
        }

        let displayContent = '';
        
        function parseMarkdown(text) {
            let html = text;
            
            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
            
            // Bold text
            html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
            
            // Italic text  
            html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');
            
            // Code blocks
            html = html.replace(/`(.*?)`/gim, '<code>$1</code>');
            
            // Ordered lists
            html = html.replace(/^\d+\.\s+(.*$)/gim, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>');
            
            // Line breaks
            html = html.replace(/\n/gim, '<br>');
            
            // Clean up nested lists
            html = html.replace(/<br><li>/gim, '<li>');
            html = html.replace(/<\/li><br>/gim, '</li>');
            html = html.replace(/<ol><br>/gim, '<ol>');
            html = html.replace(/<br><\/ol>/gim, '</ol>');
            
            // Special styling for meeting sections
            html = html.replace(/<h2>会议基本信息<\/h2>/gim, '<h2>会议基本信息</h2><div class="meeting-header">');
            html = html.replace(/<h2>会议内容<\/h2>/gim, '</div><h2>会议内容</h2><div class="meeting-section">');
            html = html.replace(/<h2>待办事项<\/h2>/gim, '</div><h2>待办事项</h2><div class="meeting-section">');
            html = html.replace(/<h2>附件<\/h2>/gim, '</div><h2>附件</h2><div class="meeting-section">');
            
            // Add badges for key information
            html = html.replace(/(\*\*主题：\*\*[^<]+)/gim, '<span class="meeting-badge">主题</span>$1');
            html = html.replace(/(\*\*主持人：\*\*[^<]+)/gim, '<span class="meeting-badge">主持人</span>$1');
            html = html.replace(/(\*\*日期：\*\*[^<]+)/gim, '<span class="meeting-badge date-badge">日期</span>$1');
            html = html.replace(/(\*\*时间：\*\*[^<]+)/gim, '<span class="meeting-badge time-badge">时间</span>$1');
            
            // Style meeting items and todos
            html = html.replace(/<li>(\*\*[^*]+\*\*[^<]*)<\/li>/gim, '<div class="meeting-item">$1</div>');
            
            // Close any remaining open divs
            html += '</div>';
            
            return html;
        }

        async function typeWriter(text) {
            return new Promise((resolve) => {
                let i = 0;
                const chars = text.split('');
                
                function typeChar() {
                    if (i < chars.length) {
                        displayContent += chars[i];
                        const parsedContent = parseMarkdown(displayContent);
                        resultContent.innerHTML = parsedContent + '<span class="typing-cursor">|</span>';
                        i++;
                        setTimeout(typeChar, Math.random() * 50 + 20); // 20-70ms 随机间隔
                    } else {
                        const finalContent = parseMarkdown(displayContent);
                        resultContent.innerHTML = finalContent; // 移除光标，显示最终格式化内容
                        resolve();
                    }
                }
                
                typeChar();
            });
        }

        function setLoading(loading) {
            generateBtn.disabled = loading;
            loadingSpinner.style.display = loading ? 'block' : 'none';
            
            if (loading) {
                generateBtn.textContent = '生成中...';
                displayContent = '';
                resultContent.innerHTML = '<div class="result-empty">正在生成会议纪要，请稍候...</div>';
            } else {
                generateBtn.textContent = '生成会议纪要';
            }
        }

        function showError(message) {
            resultContent.innerHTML = `
                <div class="error-message">
                    <strong>错误：</strong> ${message}
                </div>
            `;
        }

        dialogTextArea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                generateMeetingMinutes();
            }
        });
    </script>
</body>
</html>